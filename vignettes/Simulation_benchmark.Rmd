---
title: "Comparison of different methods for calculationg weights in epiregulon with the use of the simulated data"
author: "Tomasz WÅ‚odarczyk"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```
# Introduction
This notebook compares across all options for weight computation which are available
in the epiregulon package. As a ground truth the data simulated by scMultiSim package is used. 

# Highlights

- GRN is composed of 5000 target genes and 500 transcription factors
- 9 cell clusters

# GRN preparation

```{r child = "GRN_preparation.Rmd", cache = TRUE}
```

```{r child = "basic_simulation.Rmd"}
```

```{r eval = FALSE}
#devtools::install("/gstore/project/epigen/epiregulon.benchmark", dependencies = FALSE)
library(epiregulon.benchmark)
library(scMultiSim)
tfs <- NULL
counts_removal_old <- NULL
tfs <- unique(options_$GRN[,2])
# analysed using 900Gb of RAM
# set in .Renviron R_MAX_VSIZE = "800Gb"
counts_removal <- removeTF(sim_res, BPPARAM = BiocParallel::MulticoreParam(),
                                  batch_size = 20, sim_options = options_,
                           tfs = tfs)

true_ranks_matrix <- calculateTrueActivityRanks(basic_sim_res = sim_res,
                                                counts_removal = counts_removal,
                                                sim_options = options_)

transcription_difference_matrix_new <- calculateTrueActivityRanks(basic_sim_res = sim_res,
                                                    counts_removal = counts_removal,
                                                    sim_options = options_,
                                                    transcription_effect = TRUE)
```

```{r echo = FALSE}
#counts_removal <- readRDS("/gstore/scratch/u/wlodarct/counts_removal.rds")
true_ranks_matrix <- readRDS("/gstore/scratch/u/wlodarct/true_ranks_matrix.rds")
transcription_difference_matrix <- readRDS("/gstore/scratch/u/wlodarct/transcription_difference_matrix.rds")
```


# Comparison of weight methods based on the true counts (unnormalized)

```{r}
library(epiregulon)
library(epiregulon.benchmark)
input_objects <- processSimResults(sim_res)
clusters_list <- list("lmfit" = input_objects$geneExpMatrix$label,
                      "corr" = input_objects$geneExpMatrix$label,
                      "MI" = input_objects$geneExpMatrix$label)
# skip pruning since all connections are true
# add weights using wilcoxon test
score_matrices <- {
    if(file.exists("/gstore/scratch/u/wlodarct/score_matrices_true_counts.rds"))
       readRDS("/gstore/scratch/u/wlodarct/score_matrices_true_counts.rds")
    else{
        activity_scores <- getActivity(regulon = input_objects$regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              methods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list - clusters_list,
                              exp_assay = "counts",
                              peak_assay = "peak",
                              clusters = NULL)
        saveRDS(activity_scores, "/gstore/scratch/u/wlodarct/score_matrices_true_counts.rds")
        activity_scores
    }
}
```

```{r}
library(scMultiSim)
library(epiregulon.benchmark)
methods <- c("wilcoxon", "logFC", "lmfit", "corr", "MI")
df <- data.frame()
if (file.exists("/gstore/scratch/u/wlodarct/df_true_counts.rds")){
    df <- readRDS("/gstore/scratch/u/wlodarct/df_true_counts.rds")
}
for(i in seq_along(score_matrices)){
    if (methods[i] %in% df$method) next
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices[[i]],
                                         true_ranks_matrix = true_ranks_matrix)

    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), 
                               method = methods[i], 
                               interchanges = method_res$interchange_number))
    saveRDS(df, "/gstore/scratch/u/wlodarct/df_true_counts.rds")
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch")
```


# Comparison of weight methods based on the observed counts (unnormalized)

```{r}
score_matrices_2 <- {
    if(file.exists("/gstore/scratch/u/wlodarct/score_matrices_obs_counts.rds"))
       readRDS("/gstore/scratch/u/wlodarct/score_matrices_obs_counts.rds")
    else{
        activity_scores <- getActivity(regulon = input_objects$regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              methods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list - clusters_list,
                              exp_assay = "counts_obs",
                              peak_assay = "peak_obs",
                              clusters = NULL)
        saveRDS(activity_scores, "/gstore/scratch/u/wlodarct/score_matrices_obs_counts.rds")
        activity_scores
    }
}

```

```{r}
df <- data.frame()
if (file.exists("/gstore/scratch/u/wlodarct/df_obs_counts.rds")){
    df <- readRDS("/gstore/scratch/u/wlodarct/df_obs_counts.rds")
}
for(i in seq_along(score_matrices_2)){
    if (methods[i] %in% df$method) next
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices_2[[i]],
                                         true_ranks_matrix = true_ranks_matrix)

    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), method = methods[i], interchanges = method_res$interchange_number))
    saveRDS(df, "/gstore/scratch/u/wlodarct/df_obs_counts.rds")
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch")
```



# Comparison of weight methods based on the observed counts (normalized and log transformed)

```{r echo = FALSE}
score_matrices_3 <- {
    if(file.exists("/gstore/scratch/u/wlodarct/score_matrices_true_logcounts.rds"))
       readRDS("/gstore/scratch/u/wlodarct/score_matrices_true_logcounts.rds")
    else{
        activity_scores <- getActivity(regulon = input_objects$regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              methods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list - clusters_list,
                              exp_assay = "logcounts",
                              peak_assay = "peak",
                              clusters = NULL)
        saveRDS(activity_scores, "/gstore/scratch/u/wlodarct/score_matrices_true_logcounts.rds")
        activity_scores
    }
}

```

```{r echo = FALSE}
df <- data.frame()
if (file.exists("/gstore/scratch/u/wlodarct/df_true_logcounts.rds")){
    df <- readRDS("/gstore/scratch/u/wlodarct/df_true_logcounts.rds")
}
for(i in seq_along(score_matrices_3)){
    if (methods[i] %in% df$method) next
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices_3[[i]],
                                         true_ranks_matrix = true_ranks_matrix)

    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), method = methods[i], interchanges = method_res$interchange_number))
    saveRDS(df, "/gstore/scratch/u/wlodarct/df_true_logcounts.rds")
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch", main = "Rankings mismatch - log-transformed true counts")
```

# Effect of the number of target genes

```{r}
# calculate ranking mismatch score for true counts analysed using wilcoxon method in addWeights
ranking_accuracy_wilcoxon <- assessActivityAccuracy(sim_options = options_,
                                    activities_obs = score_matrices$wilcoxon,
                                    true_ranks_matrix = true_ranks_matrix)

# determine number of target genes per tf
target_number <- split(options_$GRN,options_$GRN$regulator.gene) |> 
    lapply(nrow) |> 
    {function(x) unlist(x)}()
df_2 <- data.frame(interchange_number = ranking_accuracy_wilcoxon$interchange_number, 
                 target_number = target_number[names(ranking_accuracy_wilcoxon$interchange_number)])

plot(df_2$interchange_number~df_2$target_number, type = "l", main = "Effect of regulon size on the accuracy of prediction of\ntranscription factor activity", xlab = "Number of target genes per transcription factor", ylab = "Rankings mismatch score")
```

# Effect of the network pruning (fixed cutoff, raw counts)

```{r cache = TRUE}
regulon.mixed <- addFalseConnections(input_objects$regulon) 
pruned.regulon <-  pruneRegulon(regulon = regulon.mixed,
                                expMatrix = input_objects$geneExpMatrix,
                               exp_assay = "counts",
                               peakMatrix = input_objects$peakMatrix,
                               peak_assay = "peak",
                               test = "chi.sq",
                               clusters = input_objects$geneExpMatrix$label,
                               prune_value = "pval",
                               regulon_cutoff = 0.05)

score_matrices_4 <- {
    if(file.exists("/gstore/scratch/u/wlodarct/score_matrices_pruned_regulon.rds"))
       readRDS("/gstore/scratch/u/wlodarct/score_matrices_pruned_regulon.rds")
    else{
        activity_scores <- getActivity(regulon = pruned.regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              methods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list - clusters_list,
                              exp_assay = "counts",
                              peak_assay = "peak",
                              clusters = NULL)
        saveRDS(activity_scores, "/gstore/scratch/u/wlodarct/score_matrices_pruned_regulon.rds")
        activity_scores
    }
}


# TO BE DONE

```

```{r echo = FALSE}
df <- data.frame()
for(i in seq_along(score_matrices_4)){
    if (methods[i] %in% df$method) next
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices_4[[i]],
                                         true_ranks_matrix = true_ranks_matrix)

    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), method = methods[i], interchanges = method_res$interchange_number))
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch", main = "Rankings mismatch after regulon pruning")
```
