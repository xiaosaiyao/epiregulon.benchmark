---
title: "Comparison of different methods for calculationg weights in epiregulon with the use of the simulated data"
author: "Tomasz WÅ‚odarczyk"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```
# Introduction
This notebook compares across all options for weight computation which are available
in the epiregulon package. As a ground truth the data simulated by scMultiSim package is used. 

# Highlights

- GRN is composed of 5000 target genes and 500 transcription factors
- 9 cell clusters
- normalization of the count data

# GRN preparation

```{r child = "GRN_preparation.Rmd", cache = TRUE}
```

```{r child = "basic_simulation.Rmd"}
```

```{r eval = FALSE}
library(epiregulon.benchmark)
library(scMultiSim)
tfs <- NULL
counts_removal_old <- NULL
tfs <- unique(options_$GRN[,2])
# analysed using 900Gb of RAM
# set in .Renviron R_MAX_VSIZE = "800Gb"
counts_removal <- removeTF(sim_res, BPPARAM = BiocParallel::MulticoreParam(),
                                  batch_size = 20, sim_options = options_,
                           tfs = tfs)

true_ranks_matrix <- calculateTrueActivityRanks(basic_sim_res = sim_res,
                                                counts_removal = counts_removal,
                                                sim_options = options_)

transcription_difference_matrix <- calculateTrueActivityRanks(basic_sim_res = sim_res,
                                                    counts_removal = counts_removal,
                                                    sim_options = options_,
                                                    transcription_effect = TRUE)
```

```{r echo = FALSE}
#devtools::install("/gstore/project/epigen/epiregulon.benchmark", dependencies = FALSE)
#counts_removal <- readRDS("/gstore/scratch/u/wlodarct/counts_removal.rds")
true_ranks_matrix <- readRDS("/gstore/scratch/u/wlodarct/true_ranks_matrix.rds")
transcription_difference_matrix <- readRDS("/gstore/scratch/u/wlodarct/transcription_difference_matrix.rds")
```
# Distribution of the library sizes

```{r}
hist(Matrix::colSums(sim_res$counts), main = "True counts", breaks = 30, xlab = "Total number of counts")
hist(Matrix::colSums(sim_res$counts_obs), main = "Observed counts", breaks = 30, xlab = "Total number of counts")
```

# Comparison of weight methods based on the true counts (normalized)

```{r}
library(epiregulon)
library(epiregulon.benchmark)
#source("/gstore/project/epigen/epiregulon.benchmark/R/simulation.R")
input_objects <- processSimResults(sim_res)
clusters_list <- list("lmfit" = input_objects$geneExpMatrix$label,
                      "corr" = input_objects$geneExpMatrix$label,
                      "MI" = input_objects$geneExpMatrix$label)
# skip pruning since all connections are true
score_matrices  <- score_matrices_true_counts <-  getActivity(regulon = input_objects$regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              weightMethods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list = clusters_list,
                              exp_assay = "norm_counts",
                              peak_assay = "peak_obs")
```

```{r}
library(scMultiSim)
library(epiregulon.benchmark)
df <- data.frame()
cat("Number of transcription factors retained:\n")
for(i in seq_along(score_matrices)){
    cat(sprintf("%15s: %d (%.2f%%)\n", names(score_matrices)[i], nrow(score_matrices[[i]]), nrow(score_matrices[[i]])*100/nrow(true_ranks_matrix)))
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices[[i]],
                                         true_ranks_matrix = true_ranks_matrix)

    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), 
                               method = names(score_matrices)[i], 
                               interchanges = method_res$interchange_number))
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch", main = "True normalized counts")
```


# Comparison of weight methods based on the observed counts (unnormalized)

```{r}
score_matrices <- getActivity(regulon = input_objects$regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              weightMethods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list = clusters_list,
                              exp_assay = "norm_counts_obs",
                              peak_assay = "peak_obs")

```

```{r}
df <- data.frame()
cat("Number of transcription factors retained:\n")
for(i in seq_along(score_matrices)){
    cat(sprintf("%15s: %d (%.2f%%)\n", names(score_matrices)[i], nrow(score_matrices[[i]]), nrow(score_matrices[[i]])*100/nrow(true_ranks_matrix)))
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices[[i]],
                                         true_ranks_matrix = true_ranks_matrix)

    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), method = names(score_matrices)[i], 
                               interchanges = method_res$interchange_number))
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch",  main = "Normalized observed counts")
```



# Comparison of weight methods based on the observed counts (normalized and log transformed)

```{r echo = FALSE}
score_matrices <-  getActivity(regulon = input_objects$regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              weightMethods  = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list = clusters_list,
                              exp_assay = "logcounts_obs",
                              peak_assay = "peak_obs")

```

```{r echo = FALSE}
df <- data.frame()
cat("Number of transcription factors retained:\n")
for(i in seq_along(score_matrices)){
    cat(sprintf("%15s: %d (%.2f%%)\n", names(score_matrices)[i], nrow(score_matrices[[i]]), nrow(score_matrices[[i]])*100/nrow(true_ranks_matrix)))
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices[[i]],
                                         true_ranks_matrix = true_ranks_matrix)

    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), 
                               method = names(score_matrices)[i], 
                               interchanges = method_res$interchange_number))
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch", main = "Rankings mismatch - log-transformed observed counts")
```

# Effect of the number of target genes

```{r}
# calculate ranking mismatch score for true counts analysed using wilcoxon method in addWeights
ranking_accuracy_wilcoxon <- assessActivityAccuracy(sim_options = options_,
                                    activities_obs = score_matrices_true_counts$wilcoxon,
                                    true_ranks_matrix = true_ranks_matrix)

# determine number of target genes per tf
target_number <- split(options_$GRN,options_$GRN$regulator.gene) |> 
    lapply(nrow) |> 
    {function(x) unlist(x)}()
df <- data.frame(interchange_number = ranking_accuracy_wilcoxon$interchange_number, 
                 target_number = target_number[names(ranking_accuracy_wilcoxon$interchange_number)])

plot(df$interchange_number~df$target_number, main = "Effect of regulon size on the accuracy of prediction of\ntranscription factor activity", xlab = "Number of target genes per transcription factor", ylab = "Rankings mismatch score", pch = 16, cex = 0.5)
```

# Effect of the network pruning (fixed cutoff, normalized counts)

```{r cache = TRUE}
regulon.mixed <- addFalseConnections(input_objects$regulon) 
pruned.regulon <-  pruneRegulon(regulon = regulon.mixed,
                                expMatrix = input_objects$geneExpMatrix,
                               exp_assay = "norm_counts",
                               peakMatrix = input_objects$peakMatrix,
                               peak_assay = "peak",
                               test = "chi.sq",
                               clusters = input_objects$geneExpMatrix$label,
                               prune_value = "pval",
                               regulon_cutoff = 0.05)

score_matrices <- getActivity(regulon = pruned.regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              weightMethods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list = clusters_list,
                              exp_assay = "norm_counts",
                              peak_assay = "peak")

```

```{r echo = FALSE, cache = TRUE}
df <- data.frame()
cat("Number of transcription factors retained:\n")
for(i in seq_along(score_matrices)){
    cat(sprintf("%15s: %d (%.2f%%)\n", names(score_matrices)[i], nrow(score_matrices[[i]]), nrow(score_matrices[[i]])*100/nrow(true_ranks_matrix)))
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices[[i]],
                                         true_ranks_matrix = true_ranks_matrix)


    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), method = names(score_matrices)[i], 
                               interchanges = method_res$interchange_number))
}
boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch", main = "Rankings mismatch after regulon pruning")
```


# Effect of the network pruning (moving cutoff, normalized counts)

```{r cache = TRUE}
pruned.regulon <-  pruneRegulon(regulon = regulon.mixed,
                                expMatrix = input_objects$geneExpMatrix,
                               exp_assay = "norm_counts",
                               peakMatrix = input_objects$peakMatrix,
                               peak_assay = "peak",
                               test = "chi.sq",
                               clusters = input_objects$geneExpMatrix$label,
                               prune_value = "pval",
                               regulon_cutoff = 0.05,
                               exp_cutoff = NULL,
                               peak_cutoff = NULL)

score_matrices <- getActivity(regulon = pruned.regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              weightMethods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list = clusters_list,
                              exp_assay = "norm_counts",
                              peak_assay = "peak")

```

```{r echo = FALSE, cache = TRUE}
df <- data.frame()
cat("Number of transcription factors retained:\n")
for(i in seq_along(score_matrices)){
    cat(sprintf("%15s: %d (%.2f%%)\n", names(score_matrices)[i], nrow(score_matrices[[i]]), nrow(score_matrices[[i]])*100/nrow(true_ranks_matrix)))
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices[[i]],
                                         true_ranks_matrix = true_ranks_matrix)


    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), method = names(score_matrices)[i], 
                               interchanges = method_res$interchange_number))
}

boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch", main = "Rankings mismatch after regulon pruning\nwith the use of moving cutoff")
```


# Effect of the network pruning (moving cutoff, normalized counts, peak data disregerded)

```{r cache = TRUE}
pruned.regulon <-  pruneRegulon(regulon = regulon.mixed,
                                expMatrix = input_objects$geneExpMatrix,
                               exp_assay = "norm_counts",
                               peakMatrix = input_objects$peakMatrix,
                               peak_assay = "peak",
                               test = "chi.sq",
                               clusters = input_objects$geneExpMatrix$label,
                               prune_value = "pval",
                               regulon_cutoff = 0.05,
                               exp_cutoff = NULL,
                               peak_cutoff = -1)

score_matrices <- getActivity(regulon = pruned.regulon,
                              geneExpMatrix = input_objects$geneExpMatrix,
                              peakMatrix = input_objects$peakMatrix,
                              weightMethods = c("wilcoxon", "logFC", "lmfit", "corr", "MI"),
                              clusters_list = clusters_list,
                              exp_assay = "norm_counts",
                              peak_assay = "peak")

```

```{r echo = FALSE, cache = TRUE}
df <- data.frame()
cat("Number of transcription factors retained:\n")
for(i in seq_along(score_matrices)){
    cat(sprintf("%15s: %d (%.2f%%)\n", names(score_matrices)[i], nrow(score_matrices[[i]]), nrow(score_matrices[[i]])*100/nrow(true_ranks_matrix)))
    method_res <- assessActivityAccuracy(sim_options = options_,
                                         activities_obs = score_matrices[[i]],
                                         true_ranks_matrix = true_ranks_matrix)


    df <- rbind(df, data.frame(tf = names(method_res$interchange_number), method = names(score_matrices)[i], 
                               interchanges = method_res$interchange_number))
}

boxplot(df$interchanges~df$method, xlab = "Weight method", ylab = "Rankings mismatch",
        main = "Rankings mismatch after regulon pruning\nwith the use of moving cutoff")
```

