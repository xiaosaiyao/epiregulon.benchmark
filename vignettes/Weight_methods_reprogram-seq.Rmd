---
title: "Comparison of different methods for calculationg weights in epiregulon with the use of reprogram-seq dataset"
author: "Tomasz WÅ‚odarczyk"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```
# Introduction
This notebook compares across all options for weight computation which are available
in the epiregulon package. As a ground truth the reprogram-seq dataset is used. It comes from the studies in which 
cells were modified to overexpress selected transcription factor. The results are
presented in the form of curves showing the relation between false and true positive rates.

# Highlights

- motif scores added
- filtering on motif scores

# Regulon preparation

```{r child = "pruned_regulon_reprogram-seq.Rmd", warning = FALSE, results = "hide"}
```

# Preparation of the data frame to be plotted

```{r}
Sys.setenv("BASILISK_USE_SYSTEM_DIR" = 1)
library(epiregulon.benchmark)
group_combinations <- expand.grid("", c("GATA6", "NKX2.1"), NA, "up", "")
colnames(group_combinations) <- c("cell_line", "experimental_treatment", "control_treatment", "effect_direction", "transcription_factor")
not_NKX21 <- grep("NKX2.1", unique(GeneExpressionMatrix$hash_assignment), invert = TRUE, value = TRUE)
group_combinations$control_treatment[group_combinations$experimental_treatment == "NKX2.1"] <- paste(not_NKX21, collapse = "|")
not_GATA6 <- grep("GATA6", unique(GeneExpressionMatrix$hash_assignment), invert = TRUE, value = TRUE)
group_combinations$control_treatment[group_combinations$experimental_treatment == "GATA6"] <- paste(not_GATA6, collapse = "|")
group_combinations$transcription_factor <- group_combinations$experimental_treatment
group_combinations$transcription_factor <- gsub("\\.","-",group_combinations$transcription_factor)
plot_data <- data.frame()

######
# ArchR project path to be changed
######
```

```{r results = "hide", cache = TRUE}
arg.list <- list()
arg.list$peakMatrix = PeakMatrix
arg.list$peak_assay = "counts"
weight_clusters  <- as.list(setNames(c("Clusters", "Clusters", "Clusters"), c("corr", "MI", "lmfit")))
for (method in  c("corr", "MI", "lmfit","logFC","wilcoxon")){
    arg.list$method = method
    partial_data <- prepare_plot_data(regulon = pruned.regulon,
                                      weight.args = arg.list,
                                      group_combinations = group_combinations,
                                      geneExprMatrix.sce = GeneExpressionMatrix,
                                      weight_clusters = weight_clusters[[method]],
                                      activity_clusters = NA)
    plot_data <- rbind(plot_data, partial_data)
}

```

```{r}
library(dplyr)
library(ggplot2)

ggplot(plot_data, aes(x=FPR, y=TPR))+
    geom_line()+
    facet_grid(treatment~method)+
    xlab("False positive rate")+
    ylab("True positive rate")+
    ggtitle("ROC curves for reprogram-seq dataset")


AUC_data <- plot_data %>% group_by(cell_line, treatment, method, tf) %>%
    group_map(function(x,y) cbind(y, data.frame(AUC = calculate_AUC(x$FPR, x$TPR))))
AUC_data <- do.call(rbind, AUC_data)

print(AUC_data)
    
```

```{r}
GRN_list <- list()
weight.args <- list()
# epiregulon workflow
weight.args$clusters <- as.vector(GeneExpressionMatrix$Clusters)
weight.args$regulon <- pruned.regulon
weight.args$expMatrix <- GeneExpressionMatrix
weight.args$peakMatrix = PeakMatrix
weight.args$peak_assay = "counts"
weight.args$method = "corr"
regulon.w <- do.call(addWeights, weight.args)
GRN_list[["Epiregulon"]] <- regulon.w
```

```{r child = "Pando_reprogram-seq.Rmd"}
```

```{r}
GRN_list[["Pando"]] <- Seurat_obj 
```


```{r child = "cellOracle_reprogram-seq.Rmd"}
```

```{r}
GRN_list[["cellOracle"]] <- links
colData(GeneExpressionMatrix)$cluster_cellOracle <- louvain_clusters
```

```{r child = "FigR_reprogram-seq.Rmd"}
```

```{r}
GRN_list[["FigR"]] <- FigR_GRN
saveRDS(GRN_list, "GRN_list.rds")
```

```{r cache = TRUE}
matrices_list <- list()
for(i in seq_along(GRN_list)){
    GRN <- GRN_list[[i]]
    method <- names(GRN_list)[i]
    activity.matrix <- get_activity_matrix(GRN = GRN,
                                           method = method,
                                           geneExprMatrix.sce = GeneExpressionMatrix,
                                           tfs = c("GATA6", "NKX2-1", "FOXA2"))
  matrices_list[[i]] <- activity.matrix 
}

names(matrices_list) <- names(GRN_list)
AUC_table <- data.frame()
for (tf in c("GATA6", "NKX2-1", "FOXA2")){
    positive_elements_label <- grep(tf, unique(GeneExpressionMatrix$hash_assignment), value = TRUE)
    negative_elements_label <- grep(tf, unique(GeneExpressionMatrix$hash_assignment), value = TRUE, invert = TRUE)
    for(i in seq_along(matrices_list)){
        activity.matrix <- activity_matrices[[i]]
        labels <- colData(GeneExpressionData[,colnames(activity.matrix)])$hash_assignment
        if(i == 1) {
                AUC <- getResultsFromActivity(activity.matrix = activity.matrix,
                              tf = tf,
                              labels = labels,
                              add_plot = FALSE,
                              positive_elements_label = positive_elements_label,
                              negative_elements_label = negative_elements_label,
                              main = sprintf("Reprogram-seq dataset\n%s", tf),
                              xlab = "False positive rate",
                              ylab = "True positive rate")
        }
        else{
            AUC <- getResultsFromActivity(activity.matrix = activity.matrix,
                                  tf = tf,
                                  labels = labels,
                                  add_plot = TRUE,
                                  positive_elements_label = positive_elements_label,
                                  negative_elements_label = negative_elements_label)
        }
        AUC_table <- rbind(AUC_table, data.frame(AUC = AUC, tf = tf, method = names(matrices_list)[i]))
    }
}
print(AUC_table)
```




